<template>
  <iep-dialog :dialog-show="dialogShow" title="详情" width="700px" @close="close">
    <el-form :model="form" size="small" ref="form" label-width="120px">

      <el-form-item label="支出类型：">
        <iep-div-detail :value="form.typeValue"></iep-div-detail>
      </el-form-item>

      <el-form-item label="支出时间：">
        <iep-div-detail :value="form.createTime"></iep-div-detail>
      </el-form-item>

      <el-form-item label="支出组织：">
        <iep-div-detail :value="form.orgName"></iep-div-detail>
      </el-form-item>

      <el-form-item label="支出方式：">
        <iep-div-detail :value="dictsMap.expenditureMode[form.expenditureMode]"></iep-div-detail>
      </el-form-item>

      <el-form-item label="支出公司：">
        <iep-div-detail :value="form.companyName"></iep-div-detail>
      </el-form-item>

      <el-form-item label="银行户头：">
        <iep-div-detail :value="form.accountName"></iep-div-detail>
      </el-form-item>

      <el-form-item label="关联合同：">
        <iep-div-detail :value="form.protocolName"></iep-div-detail>
      </el-form-item>

      <el-form-item label="关联项目：">
        <iep-div-detail :value="form.projectName"></iep-div-detail>
      </el-form-item>

      <el-form-item label="项目编号：">
        <iep-div-detail :value="form.projectNumber"></iep-div-detail>
      </el-form-item>

      <el-form-item label="支出金额：">
        <iep-div-detail :value="form.amount+' 元'"></iep-div-detail>
      </el-form-item>

      <!-- <el-form-item label="税率：">
        <iep-div-detail :value="(form.taxRate*100)+'%'"></iep-div-detail>
      </el-form-item> -->

      <el-form-item v-if="form.parentType==='17'" label="计息比率：">
        <iep-div-detail :value="form.interestRate+'%'"></iep-div-detail>
      </el-form-item>

      <el-form-item v-if="form.parentType==='23'" label="预计退款时间：">
        <iep-div-detail :value="form.estimatedRefundTime"></iep-div-detail>
      </el-form-item>

      <el-form-item label="备注：">
        <iep-div-detail :value="form.remarks"></iep-div-detail>
      </el-form-item>

      <el-form-item label="操作人：">
        <iep-div-detail :value="form.realName"></iep-div-detail>
      </el-form-item>

      <h2 style="text-align: center;">代缴</h2>
      <el-table :data="form.relations" style="width: 100%" size="small" border show-summary>
        <el-table-column prop="orgId" label="组织名称">
          <template slot-scope="scope">
            <iep-div-detail :value="scope.row.orgName"></iep-div-detail>
          </template>
        </el-table-column>
        <el-table-column prop="amount" label="金额(元)">
          <template slot-scope="scope">
            <iep-div-detail :value="scope.row.amount"></iep-div-detail>
          </template>
        </el-table-column>
      </el-table>

      <template v-if="form.parentType==='17'">
        <el-form-item label="">
          <operation-wrapper>
            <iep-button @click="handleIncome()">新增其他应收款收入</iep-button>
            <iep-button @click="handleShow()">查看其他应收款收入</iep-button>
          </operation-wrapper>
        </el-form-item>
      </template>

    </el-form>
    <dialog-form ref="DialogForm" @load-page="loadPage"></dialog-form>
    <incomes ref="Incomes" :forms="forms" @load-page="loadPage"></incomes>
  </iep-dialog>
</template>
<script>
import { mapGetters } from 'vuex'
import { postIncome } from '@/api/fams/income'
import { initForm, dictsMap } from './options'
import DialogForm from '../IManagement/DialogForm'
import Incomes from './Incomes'
import { getExpenditureById } from '@/api/fams/expenditure'
import { getIncomeById } from '@/api/fams/income'
export default {
  components: { DialogForm, Incomes },
  data () {
    return {
      id: '',
      dictsMap,
      dialogShow: false,
      form: initForm(),
      forms: [],
    }
  },
  computed: {
    ...mapGetters([
      'userInfo',
    ]),
  },
  methods: {
    handleShow () {
      this.form.incomeIds.map(async (idx) => {
        const data = (await getIncomeById(idx)).data.data
        this.forms.push(data)
      })
      this.$refs['Incomes'].dialogShow = true
    },
    handleIncome () {
      this.$refs['DialogForm'].form = initForm()
      this.$refs['DialogForm'].formRequestFn = postIncome
      this.$refs['DialogForm'].form.expenditureId = this.form.expenditureId
      this.$refs['DialogForm'].form.orgId = this.userInfo.orgId
      this.$refs['DialogForm'].form.invoiceOrgId = this.userInfo.orgId
      this.$refs['DialogForm'].form.orgName = this.userInfo.orgName
      this.$refs['DialogForm'].dialogShow = true
    },
    loadPage () {
      getExpenditureById(this.id).then(({ data }) => {
        this.form = data.data
        this.forms = []
      })
    },
    close () {
      this.form = initForm()
      this.dialogShow = false
      this.$emit('load-page')
    },
  },
}
</script>
